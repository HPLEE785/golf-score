<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高爾夫分數紀錄卡 - v58 12人版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* =========================================
           CSS 樣式表 (v58)
           ========================================= */
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f7f6; padding: 5px; padding-bottom: 300px; user-select: none; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        /* 控制面板 */
        .main-controls { max-width: 100%; margin: 0 auto 10px auto; background: #fff; padding: 8px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 1em; }
        .control-group { display: flex; align-items: center; gap: 4px; }
        .label-text { font-weight: bold; color: #333; font-size: 0.9em; }
        
        .action-btn { background-color: #2c3e50; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 1em; cursor: pointer; }
        .zone-select-btn { background-color: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 1.1em; min-width: 120px; white-space: nowrap; text-align: center; }
        .btn-reset { background-color: #7f8c8d; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: bold; }
        .edit-toggle-label { display: flex; align-items: center; font-size: 0.9em; color: #c0392b; font-weight: bold; border: 1px solid #c0392b; padding: 4px 8px; border-radius: 4px; background: #fff; }

        /* 表格容器 */
        .card-container { max-width: 100%; margin: 0 auto 15px auto; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; overflow-x: auto; }
        .zone-header { background-color: #27ae60; color: white; padding: 8px 12px; font-size: 1.3em; font-weight: bold; display: flex; gap: 10px; }
        table { width: 100%; border-collapse: collapse; text-align: center; min-width: 800px; }
        th, td { border: 1px solid #ddd; padding: 2px 1px; background: #fff; }
        thead th { background: #7f8c8d; color: white; }

        /* 左側資訊與底色規則 */
        .col-combined-header { width: 50px; background: #546e7a !important; color: white; font-size: 0.9em; }
        .col-combined-cell { border-right: 2px solid #ccc; padding: 2px !important; cursor: pointer; }
        .hole-val { font-size: 1.1em; font-weight: bold; }
        .hdcp-val { font-family: "Segoe UI Emoji", sans-serif; font-size: 1.0em; font-weight: 900; opacity: 0.9; }

        /* 底色規則 */
        .bg-par-3 { background-color: #ffcdd2 !important; color: #b71c1c; } /* 紅色底 */
        .bg-par-3 .hole-val, .bg-par-3 .hdcp-val { color: #b71c1c; }
        .bg-par-4 { background-color: #ffffff !important; color: #333; } /* 白色底 */
        .bg-par-4 .hole-val, .bg-par-4 .hdcp-val { color: #333; }
        .bg-par-5 { background-color: #bbdefb !important; color: #0d47a1; } /* 藍色底 */
        .bg-par-5 .hole-val, .bg-par-5 .hdcp-val { color: #0d47a1; }

        @keyframes blink-red { 0% { color: red; opacity: 1; } 50% { color: red; opacity: 0.3; } 100% { color: red; opacity: 1; } }
        .editing-text { color: red !important; animation: blink-red 1s infinite; }
        .active-editing-row td { background-color: #fff59d !important; border-top: 2px solid #fbc02d; border-bottom: 2px solid #fbc02d; color: #000; }

        /* ★ 修正：玩家欄位寬度固定 90px */
        .player-header { min-width: 90px; width: 90px; max-width: 90px; }
        .player-name-btn { background: none; border: 1px solid transparent; font-size: 0.95em; font-weight: bold; color: white; cursor: pointer; padding: 2px; width: 100%; border-radius: 4px; display: block; margin-bottom: 2px; min-height: 28px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .player-name-btn:hover { background-color: rgba(255,255,255,0.2); }
        .clickable-name { border: 1px dashed rgba(255,255,255,0.5); background: rgba(0,0,0,0.1); } 

        .info-row { display: flex; justify-content: center; align-items: center; gap: 1px; margin-bottom: 2px; }
        .handicap-btn { display: inline-block; background-color: #e8f4f8; border: 1px solid #b3d7ff; color: #0056b3; padding: 0 2px; border-radius: 6px; cursor: pointer; height: 20px; line-height: 18px; font-size: 0.8em; min-width: 30px; }
        .host-btn { display: inline-block; background-color: #fff3e0; border: 1px solid #ffe0b2; color: #ef6c00; padding: 0 2px; border-radius: 6px; height: 20px; line-height: 18px; font-size: 0.8em; cursor: default; }

        .stats-container { display: flex; justify-content: center; gap: 1px; margin-top: 2px; padding-top: 2px; border-top: 1px dashed rgba(255,255,255,0.3); }
        .stats-btn { width: 24px; height: 20px; font-size: 11px; font-weight: bold; border-radius: 3px; border: 1px solid #bdc3c7; background: #fff; display: flex; align-items: center; justify-content: center; cursor: default; color: #333; }
        .stats-ba { color: #e74c3c; border-color: #e74c3c; }
        .stats-bb { color: #2980b9; border-color: #2980b9; }
        .stats-bb.negative { color: red; background-color: #ffebee; }
        .stats-bb.positive { color: blue; background-color: #e3f2fd; }

        .score-btn { width: 32px; height: 32px; font-size: 16px; font-weight: bold; border-radius: 4px; cursor: pointer; margin-bottom: 2px; transition: all 0.1s; background-color: #fff; border: 1px dashed #ccc; color: #ccc; -webkit-user-select: none; padding: 0; }
        .score-btn:active { transform: scale(0.95); }
        
        .style-par { background: #ffcc80; border: 1px solid #ef6c00; color: #000; }
        .style-bogey { border: 2px solid #000; color: #000; }
        .style-double-bogey { border: 2px solid #000; color: #000; box-shadow: inset 0 0 0 2px #fff, inset 0 0 0 4px #000; }
        .style-birdie { border: 2px solid red; color: red; border-radius: 50%; }
        .style-eagle { border: 2px solid red; color: red; border-radius: 50%; box-shadow: inset 0 0 0 2px #fff, inset 0 0 0 4px red; }

        .sub-btn-container { display: flex; justify-content: center; gap: 1px; height: 22px; }
        .btn-ba, .btn-bb { width: 15px; height: 22px; background: #fff; border: 1px solid #ccc; border-radius: 3px; font-weight: bold; font-size: 9px; padding: 0; pointer-events: none; }
        .btn-ba { color: #e74c3c; border: 1px solid #999; cursor: pointer; pointer-events: auto; }
        .active-ba-bg { background-color: #81c784 !important; border-color: #4caf50 !important; }
        
        .btn-bb { background: #f9f9f9; color: blue; } 
        .btn-bb.lose { color: red; }
        .btn-bb.handicap-applied { background-color: #ffe0e0 !important; border-color: #ffcccc !important; }

        tr.total-row td { background-color: #34495e !important; color: white; font-weight: bold; border-top: 2px solid #2c3e50; padding: 4px; vertical-align: middle; }
        .val-sub { font-size: 1.2em; color: #f1c40f; display:block; margin-bottom: 2px; line-height:1.1;} 
        .val-grand { font-size: 0.9em; color: #fff; border-top: 1px solid rgba(255,255,255,0.3); display:block; width: 80%; margin:0 auto; line-height:1.1;} 

        .pk-header { background: #e67e22; color: white; padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 1.2em; font-weight: bold; }
        .pk-hole-header { font-weight: bold; color: #333; min-width: 30px; font-size: 0.9em; }
        .pk-score-cell { font-size: 1.1em; font-weight: bold; width: 35px; height: 40px; vertical-align: middle; }
        
        /* ★ 修正：PK 玩家按鈕寬度固定 120px */
        .pk-name-btn { background: #f39c12; color: white; border: none; padding: 4px 4px; border-radius: 4px; font-size: 1.0em; font-weight: bold; cursor: pointer; width: 120px; min-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .pk-status { font-size: 0.9em; font-weight: bold; margin-top: 2px; }
        .pk-status.win { color: blue; } .pk-status.lose { color: red; }

        .custom-player-area { background: #fff; padding: 10px; margin: 10px auto; max-width: 100%; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .custom-input-group { display: flex; gap: 6px; flex-wrap: wrap; }
        .custom-input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex: 0 0 calc(50% - 3px); box-sizing: border-box; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-box { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; }
        .modal-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .modal-btn { padding: 10px; border: none; border-radius: 5px; font-size: 1em; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">

    <div class="main-controls">
        <div class="control-group">
            <span class="label-text">球場:</span>
            <button class="action-btn" @click="toggleCourse">{{ currentCourseName }}</button>
        </div>
        
        <label class="edit-toggle-label">
            <input type="checkbox" v-model="isEditMode" style="margin-right:4px;"> 編輯玩家
        </label>

        <button class="btn-reset" @click="resetAllData">⚠️ 清除 v58</button>

        <div class="control-group" style="margin-left:5px;">
            <span class="label-text">前 9 :</span>
            <button class="zone-select-btn" @click="tryToggleZone('z1')">{{ currentZone1 }}</button>
        </div>

        <div class="control-group">
            <span class="label-text">後 9 :</span>
            <button class="zone-select-btn" @click="tryToggleZone('z2')">{{ currentZone2 }}</button>
        </div>
    </div>

    <div class="card-container" v-for="zKey in ['z1', 'z2']" :key="zKey">
        <div class="zone-header">
            {{ zKey === 'z1' ? '前 9' : '後 9' }}: {{ getZoneName(zKey) }}
        </div>
        <table>
            <thead>
                <tr>
                    <th class="col-combined-header">Hole<br><span style="font-size:0.8em; opacity:0.8;">HDCP</span></th>
                    <th v-for="colIdx in 12" :key="colIdx-1" class="player-header">
                        <button class="player-name-btn" 
                                :class="{ 'clickable-name': isEditMode }"
                                @click="cyclePlayerName(colIdx-1)">
                            {{ columnNames[colIdx-1] || '...' }}
                        </button>
                        <div class="info-row">
                            <div v-if="colIdx === 1" class="host-btn">爐主</div>
                            <div v-else class="handicap-btn" @click="toggleHandicap(colIdx-1, zKey)">讓 {{ handicaps[zKey][colIdx-1] }}</div>
                        </div>
                        <div class="stats-container">
                            <div class="stats-btn stats-ba" style="color:#e74c3c;">{{ countBA(colIdx-1, zKey) }}</div>
                            <div class="stats-btn stats-bb" 
                                 :class="{'positive': countBB(colIdx-1, zKey)>0, 'negative': countBB(colIdx-1, zKey)<0}">
                                {{ countBB(colIdx-1, zKey) > 0 ? '+' + countBB(colIdx-1, zKey) : countBB(colIdx-1, zKey) }}
                            </div>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(hole, rIdx) in getZoneData(zKey).holes" :key="rIdx"
                    :class="{ 'active-editing-row': activeEditingRow?.zKey === zKey && activeEditingRow?.rIdx === rIdx }">
                    
                    <td class="col-combined-cell" 
                        :class="getParBgClass(getZoneData(zKey).par[rIdx])"
                        @click="handleHoleClick(zKey, rIdx)">
                        <div class="cell-content">
                            <div class="hole-val" :class="{ 'editing-text': isRowEditing(zKey, rIdx) }">{{ hole }}</div>
                            <div class="hdcp-val" :class="{ 'editing-text': isRowEditing(zKey, rIdx) }">
                                ⛳ {{ getZoneData(zKey).hdcp[rIdx] }}
                            </div>
                        </div>
                    </td>

                    <td v-for="colIdx in 12" :key="colIdx-1">
                        <button class="score-btn" 
                                :class="[getScoreClass(scores[zKey][rIdx][colIdx-1], getZoneData(zKey).par[rIdx]), { 'locked-btn': !isRowEditing(zKey, rIdx) }]"
                                @click.stop="updateScore(zKey, rIdx, colIdx-1)">
                            {{ scores[zKey][rIdx][colIdx-1] }}
                        </button>
                        <div class="sub-btn-container">
                            <button class="btn-ba" 
                                    :class="{ 'active-ba-bg': baSelections[zKey][rIdx] !== null }"
                                    @click="toggleBA(zKey, rIdx, colIdx-1)">
                                {{ baSelections[zKey][rIdx] === (colIdx-1) ? 'O' : '' }}
                            </button>
                            <button v-if="colIdx > 1" class="btn-bb" 
                                    :class="getBBClass(zKey, rIdx, colIdx-1)">
                                {{ calculateBB(zKey, rIdx, colIdx-1).text }}
                            </button>
                        </div>
                    </td>
                </tr>

                <tr class="total-row">
                    <td>{{ zKey === 'z1' ? '前 9' : '後 9' }}<br>總桿</td>
                    <td v-for="colIdx in 12" :key="colIdx-1">
                        <div class="total-display-container">
                            <span class="val-sub">{{ calculateGross(zKey, colIdx-1) }}</span>
                            <span class="val-grand">{{ calculateGrandTotal(colIdx-1) }}</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card-container" style="border: 2px solid #e67e22;">
        <div class="pk-header"><span>⚔️ PK 專區</span></div>
        <table>
            <thead>
                <tr>
                    <th style="min-width:60px;">前 9</th>
                    <th v-for="(hole, i) in getZoneData('z1').holes" :key="i" class="pk-hole-header" :class="getParBgClass(getZoneData('z1').par[i])">{{ hole }}</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <button class="pk-name-btn" @click="togglePkPlayer(1)">{{ pk.p1 }}</button>
                        <div class="host-btn" style="margin-top:2px; font-size:0.8em;">爐主</div>
                        <div class="pk-status" :class="pkResults.f9.p1Cls">{{ pkResults.f9.p1Txt }}</div>
                    </td>
                    <td v-for="(val, i) in pkResults.f9.scores.p1" :key="i" class="pk-score-cell" :class="getScoreClass(val, getZoneData('z1').par[i])">{{ val }}</td>
                    <td style="font-weight:bold;">{{ pkResults.f9.totals.p1 || '' }}</td>
                </tr>
                <tr>
                    <td>
                        <button class="pk-name-btn" @click="togglePkPlayer(2)">{{ pk.p2 }}</button>
                        <div class="handicap-btn" style="margin-top:2px; font-size:0.8em;" @click="togglePkHdcp('f9')">讓 {{ pk.hdcp_f9 }}</div>
                        <div class="pk-status" :class="pkResults.f9.p2Cls">{{ pkResults.f9.p2Txt }}</div>
                    </td>
                    <td v-for="(val, i) in pkResults.f9.scores.p2" :key="i" class="pk-score-cell" :class="getScoreClass(val, getZoneData('z1').par[i])">{{ val }}</td>
                    <td style="font-weight:bold;">{{ pkResults.f9.totals.p2 || '' }}</td>
                </tr>
            </tbody>
            <thead style="border-top: 3px solid #e67e22;">
                <tr>
                    <th>後 9</th>
                    <th v-for="(hole, i) in getZoneData('z2').holes" :key="i" class="pk-hole-header" :class="getParBgClass(getZoneData('z2').par[i])">{{ hole }}</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span style="font-weight:bold;">{{ pk.p1 }}</span><div class="pk-status" :class="pkResults.b9.p1Cls">{{ pkResults.b9.p1Txt }}</div></td>
                    <td v-for="(val, i) in pkResults.b9.scores.p1" :key="i" class="pk-score-cell" :class="getScoreClass(val, getZoneData('z2').par[i])">{{ val }}</td>
                    <td style="font-weight:bold;">{{ pkResults.b9.totals.p1 || '' }}</td>
                </tr>
                <tr>
                    <td><span style="font-weight:bold;">{{ pk.p2 }}</span><div class="handicap-btn" style="margin-top:2px; font-size:0.8em;" @click="togglePkHdcp('b9')">讓 {{ pk.hdcp_b9 }}</div><div class="pk-status" :class="pkResults.b9.p2Cls">{{ pkResults.b9.p2Txt }}</div></td>
                    <td v-for="(val, i) in pkResults.b9.scores.p2" :key="i" class="pk-score-cell" :class="getScoreClass(val, getZoneData('z2').par[i])">{{ val }}</td>
                    <td style="font-weight:bold;">{{ pkResults.b9.totals.p2 || '' }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="custom-player-area">
        <span style="font-weight:bold; color:#555; display:block; margin-bottom:5px;">非定義玩家 (輸入後自動加入名單)</span>
        <div class="custom-input-group">
            <input v-for="(name, idx) in customPlayers" :key="idx" type="text" class="custom-input" 
                   v-model="customPlayers[idx]" :placeholder="'玩家 ' + String.fromCharCode(65+idx)">
        </div>
    </div>

    <div v-if="showZoneModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">⚠️ 該球道已有資料</div>
            <div class="modal-buttons">
                <button class="modal-btn" style="background:#2980b9; color:white;" @click="confirmZoneChange(false)">保留資料</button>
                <button class="modal-btn" style="background:#e67e22; color:white;" @click="confirmZoneChange(true)">清除資料</button>
                <button class="modal-btn" style="background:#95a5a6; color:white;" @click="showZoneModal = false">取消</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, reactive, computed, watch, onMounted, toRefs } = Vue;

    createApp({
        setup() {
            const STORAGE_KEY = 'golf_scorecard_v58_12players';
            const basePlayers = ["張簡榮力", "洪忠宜", "陳振峯", "趙振明", "李子瑋", "張嘉原", "巫吉生", "吳建輝", "林政翰", "陳威宇", "范秀蘭", "謝旼達", "高台玉", "張銘德"];
            
            const state = reactive({
                currentCourseName: "台中國際",
                currentZone1: "東區",
                currentZone2: "西區",
                isEditMode: false,
                customPlayers: ["", "", "", ""],
                activeEditingRow: null,
                showZoneModal: false,
                pendingZoneChange: null,
                
                // ★ 修正：scores 擴充至 12 欄
                scores: {
                    z1: Array(9).fill().map(() => Array(12).fill("")),
                    z2: Array(9).fill().map(() => Array(12).fill(""))
                },
                
                baSelections: {
                    z1: Array(9).fill(null),
                    z2: Array(9).fill(null)
                },

                // ★ 修正：讓桿獨立設定，且擴充至 12 人
                handicaps: {
                    z1: Array(12).fill(4),
                    z2: Array(12).fill(4)
                },

                // ★ 新增：紀錄 12 個欄位目前顯示的玩家名稱 (可含空白)
                // 預設前4個欄位填入前4位玩家，其餘空白
                columnNames: Array(12).fill("").map((_, i) => i < 4 ? basePlayers[i] : ""),

                pk: { p1: basePlayers[0], p2: basePlayers[1], hdcp_f9: 4, hdcp_b9: 4 }
            });

            const courseDB = {
                "台中國際": {
                    "東區": { holes: ["東1","東2","東3","東4","東5","東6","東7","東8","東9"], par: [4,4,3,5,4,4,3,5,4], hdcp: [2,8,5,4,7,1,9,3,6] },
                    "中區": { holes: ["中1","中2","中3","中4","中5","中6","中7","中8","中9"], par: [4,4,3,5,4,4,3,4,5], hdcp: [7,2,8,5,4,1,9,3,6] },
                    "西區": { holes: ["西1","西2","西3","西4","西5","西6","西7","西8","西9"], par: [5,4,3,4,4,3,4,5,4], hdcp: [3,6,9,8,1,4,7,2,5] }
                },
                "豐原球場": {
                    "OUT": { holes: ["1","2","3","4","5","6","7","8","9"], par: [4,5,5,3,4,4,3,4,3], hdcp: [5,3,7,15,1,9,17,11,13] },
                    "IN": { holes: ["10","11","12","13","14","15","16","17","18"], par: [5,3,4,3,4,3,5,4,5], hdcp: [4,18,2,16,10,14,12,6,8] }
                },
                "彰化球場": {
                    "OUT": { holes: ["1","2","3","4","5","6","7","8","9"], par: [5,3,4,4,4,5,4,4,3], hdcp: [3,17,1,11,7,13,9,5,15] },
                    "IN": { holes: ["10","11","12","13","14","15","16","17","18"], par: [5,3,4,4,4,4,3,5,5], hdcp: [4,16,2,18,6,8,14,10,12] }
                },
                "清泉崗球場": {
                    "OUT": { holes: ["1","2","3","4","5","6","7","8","9"], par: [4,4,4,3,4,4,5,4,4], hdcp: [11,1,5,9,3,15,7,13,17] },
                    "IN": { holes: ["10","11","12","13","14","15","16","17","18"], par: [4,3,4,5,4,4,5,3,4], hdcp: [4,12,16,8,10,2,6,18,14] }
                },
                "全國球場": {
                    "OUT": { holes: ["1","2","3","4","5","6","7","8","9"], par: [4,4,5,4,3,4,5,3,4], hdcp: [17,11,9,5,13,1,3,15,7] },
                    "IN": { holes: ["10","11","12","13","14","15","16","17","18"], par: [4,3,4,5,3,4,5,4,4], hdcp: [18,16,12,10,14,2,4,6,8] }
                },
                "南峰球場": {
                    "OUT": { holes: ["1","2","3","4","5","6","7","8","9"], par: [5,4,4,3,4,4,3,5,4], hdcp: [3,9,15,13,5,1,17,11,7] },
                    "IN": { holes: ["10","11","12","13","14","15","16","17","18"], par: [5,3,4,4,3,4,5,4,4], hdcp: [4,18,10,6,14,2,8,12,16] }
                }
            };

            const allPlayerNames = computed(() => {
                const extras = state.customPlayers.filter(n => n !== "");
                return [...basePlayers, ...extras];
            });

            const getZoneData = (zKey) => {
                const zoneName = zKey === 'z1' ? state.currentZone1 : state.currentZone2;
                return courseDB[state.currentCourseName][zoneName] || { holes:[], par:[], hdcp:[] };
            };

            const calculateBB = (zKey, rIdx, colIdx) => {
                // 如果該欄位沒有名字，不計算
                if (!state.columnNames[colIdx]) return { text: '', isHdcp: false };
                if (colIdx === 0) return { text: '', isHdcp: false }; 
                
                const zData = getZoneData(zKey);
                const s1 = parseInt(state.scores[zKey][rIdx][0]); 
                const s2 = parseInt(state.scores[zKey][rIdx][colIdx]); 
                const hdcpVal = zData.hdcp[rIdx]; 
                // ★ 修正：從對應區域的 handicaps 陣列取值
                const userHandicap = state.handicaps[zKey][colIdx]; 

                const sortedHdcp = [...zData.hdcp].sort((a, b) => a - b);
                let cutoffHdcp = 0;
                if (userHandicap > 0) {
                    let safeIdx = Math.min(userHandicap, 9) - 1;
                    cutoffHdcp = sortedHdcp[safeIdx];
                }
                
                const isHdcp = (hdcpVal <= cutoffHdcp);

                if (isNaN(s1) || isNaN(s2)) return { text: '', isHdcp };

                let netS2 = s2 - (isHdcp ? 1 : 0);
                let diff = '';
                
                if (netS2 < s1) {
                    let pts = (s2 < zData.par[rIdx]) ? 2 : 1; 
                    diff = `+${pts}`;
                } else if (netS2 > s1) {
                    let pts = (s1 < zData.par[rIdx]) ? 2 : 1;
                    diff = `-${pts}`;
                }
                
                return { text: diff, isHdcp };
            };

            const pkResults = computed(() => {
                const calc = (zKey, p1Name, p2Name, p2Hdcp) => {
                    const zData = getZoneData(zKey);
                    
                    let p1Scores = [], p2Scores = [];
                    let netTotal = 0;
                    let p1Total = 0, p2Total = 0;

                    // ★ 修正 PK 邏輯：從 12 個欄位中找名字匹配的
                    let p1Col = state.columnNames.indexOf(p1Name);
                    let p2Col = state.columnNames.indexOf(p2Name);

                    const sortedHdcp = [...zData.hdcp].sort((a,b)=>a-b);
                    let cutoff = (p2Hdcp > 0) ? sortedHdcp[Math.min(p2Hdcp,9)-1] : 0;

                    for(let i=0; i<9; i++) {
                        let s1 = (p1Col>=0) ? parseInt(state.scores[zKey][i][p1Col]) : NaN;
                        let s2 = (p2Col>=0) ? parseInt(state.scores[zKey][i][p2Col]) : NaN;
                        p1Scores.push(isNaN(s1)?'':s1);
                        p2Scores.push(isNaN(s2)?'':s2);
                        if(!isNaN(s1)) p1Total += s1;
                        if(!isNaN(s2)) p2Total += s2;

                        if(!isNaN(s1) && !isNaN(s2)) {
                            let isHdcp = zData.hdcp[i] <= cutoff;
                            let netS2 = s2 - (isHdcp ? 1 : 0);
                            if(netS2 < s1) netTotal += (s2 < zData.par[i] ? 2 : 1);
                            else if(netS2 > s1) netTotal -= (s1 < zData.par[i] ? 2 : 1);
                        }
                    }
                    
                    let p1Txt="平手", p2Txt="平手", p1Cls="", p2Cls="";
                    if(netTotal > 0) { p2Txt=`贏 ${netTotal} 洞`; p2Cls="win"; p1Txt=`輸 ${netTotal} 洞`; p1Cls="lose"; }
                    else if(netTotal < 0) { p1Txt=`贏 ${Math.abs(netTotal)} 洞`; p1Cls="win"; p2Txt=`輸 ${Math.abs(netTotal)} 洞`; p2Cls="lose"; }

                    return { scores: {p1: p1Scores, p2: p2Scores}, totals: {p1: p1Total, p2: p2Total}, p1Txt, p1Cls, p2Txt, p2Cls };
                };

                return {
                    f9: calc('z1', state.pk.p1, state.pk.p2, state.pk.hdcp_f9),
                    b9: calc('z2', state.pk.p1, state.pk.p2, state.pk.hdcp_b9)
                };
            });

            // ================= METHODS =================

            const toggleCourse = () => {
                const courses = Object.keys(courseDB);
                let idx = courses.indexOf(state.currentCourseName);
                let nextIdx = (idx + 1) % courses.length;
                state.currentCourseName = courses[nextIdx];
                const zones = Object.keys(courseDB[state.currentCourseName]);
                state.currentZone1 = zones[0];
                state.currentZone2 = zones.length > 1 ? zones[1] : zones[0];
            };

            const tryToggleZone = (zKey) => {
                const hasData = state.scores[zKey].some(row => row.some(val => val !== ""));
                const zones = Object.keys(courseDB[state.currentCourseName]);
                const currentZ = zKey === 'z1' ? state.currentZone1 : state.currentZone2;
                const nextZ = zones[(zones.indexOf(currentZ) + 1) % zones.length];

                if (hasData) {
                    state.pendingZoneChange = { zKey, nextZone: nextZ };
                    state.showZoneModal = true;
                } else {
                    if (zKey === 'z1') state.currentZone1 = nextZ;
                    else state.currentZone2 = nextZ;
                }
            };

            const confirmZoneChange = (shouldClear) => {
                const { zKey, nextZone } = state.pendingZoneChange;
                if (zKey === 'z1') state.currentZone1 = nextZone;
                else state.currentZone2 = nextZone;
                if (shouldClear) {
                    state.scores[zKey] = Array(9).fill().map(() => Array(12).fill(""));
                    state.baSelections[zKey] = Array(9).fill(null);
                }
                state.showZoneModal = false;
            };

            const handleHoleClick = (zKey, rIdx) => {
                if (state.activeEditingRow && state.activeEditingRow.zKey === zKey && state.activeEditingRow.rIdx === rIdx) {
                    state.activeEditingRow = null; 
                } else {
                    state.activeEditingRow = { zKey, rIdx }; 
                    const rowScores = state.scores[zKey][rIdx];
                    const hasAnyScore = rowScores.some(s => s !== "");
                    
                    if (!hasAnyScore) {
                        const par = getZoneData(zKey).par[rIdx];
                        // 幫所有有名字的 column 填入 PAR
                        state.columnNames.forEach((name, i) => {
                            if(name) state.scores[zKey][rIdx][i] = par;
                        });
                    }
                }
            };

            const updateScore = (zKey, rIdx, colIdx) => {
                if (!isRowEditing(zKey, rIdx)) return;
                // 如果該欄位沒名字，不給輸入
                if (!state.columnNames[colIdx]) return;

                let curr = state.scores[zKey][rIdx][colIdx];
                let next;
                if (curr === "") next = 1;
                else {
                    next = parseInt(curr) + 1;
                    if (next > 9) next = "";
                }
                state.scores[zKey][rIdx][colIdx] = next;
            };

            const toggleBA = (zKey, rIdx, colIdx) => {
                if (state.baSelections[zKey][rIdx] === colIdx) {
                    state.baSelections[zKey][rIdx] = null; 
                } else {
                    state.baSelections[zKey][rIdx] = colIdx; 
                }
            };

            const calculateGross = (zKey, colIdx) => {
                let total = 0;
                for(let i=0; i<9; i++) {
                    let s = parseInt(state.scores[zKey][i][colIdx]);
                    if(!isNaN(s)) total += s;
                }
                return total > 0 ? total : 0;
            };

            const calculateGrandTotal = (colIdx) => {
                return calculateGross('z1', colIdx) + calculateGross('z2', colIdx);
            };

            const countBA = (colIdx, zKey) => {
                return state.baSelections[zKey].filter(sel => sel === colIdx).length;
            };

            const countBB = (colIdx, zKey) => {
                let total = 0;
                for(let i=0; i<9; i++) {
                    let bb = calculateBB(zKey, i, colIdx);
                    if(bb.text.startsWith('+')) total += parseInt(bb.text.replace('+',''));
                    else if(bb.text.startsWith('-')) total -= parseInt(bb.text.replace('-',''));
                }
                return total;
            };

            const getZoneName = (zKey) => zKey === 'z1' ? state.currentZone1 : state.currentZone2;
            const isRowEditing = (zKey, rIdx) => state.activeEditingRow?.zKey === zKey && state.activeEditingRow?.rIdx === rIdx;
            
            const getParBgClass = (par) => {
                if (par === 3) return 'bg-par-3';
                if (par === 5) return 'bg-par-5';
                return 'bg-par-4';
            };

            const getScoreClass = (score, par) => {
                if(!score) return '';
                let s = parseInt(score);
                let diff = s - par;
                if(diff===0) return 'style-par';
                if(diff===1) return 'style-bogey';
                if(diff>=2) return 'style-double-bogey';
                if(diff===-1) return 'style-birdie';
                if(diff<=-2) return 'style-eagle';
                return '';
            };
            const getBBClass = (zKey, rIdx, colIdx) => {
                let bb = calculateBB(zKey, rIdx, colIdx);
                let cls = [];
                if(bb.text.startsWith('+')) cls.push('win');
                else if(bb.text.startsWith('-')) cls.push('lose');
                if(bb.isHdcp) cls.push('handicap-applied');
                return cls;
            };

            // ★ 修正：循環切換玩家邏輯 (含空白)
            // 列表：[所有玩家] + [空白]
            const cyclePlayerName = (colIdx) => {
                if(!state.isEditMode) return;
                
                let currentName = state.columnNames[colIdx];
                let allOptions = [...allPlayerNames.value, ""]; // 包含空白選項
                
                let idx = allOptions.indexOf(currentName);
                if (idx === -1) idx = -1; // 找不到就從頭開始
                
                let nextName = allOptions[(idx + 1) % allOptions.length];
                state.columnNames[colIdx] = nextName;
            };

            // ★ 修正：讓桿獨立 zKey
            const toggleHandicap = (colIdx, zKey) => {
                let h = state.handicaps[zKey][colIdx];
                state.handicaps[zKey][colIdx] = (h >= 9) ? 0 : h + 1;
            };

            const togglePkPlayer = (pNum) => {
                let curr = pNum===1 ? state.pk.p1 : state.pk.p2;
                let idx = allPlayerNames.value.indexOf(curr);
                let next = allPlayerNames.value[(idx+1) % allPlayerNames.value.length];
                if(pNum===1) state.pk.p1 = next; else state.pk.p2 = next;
            };
            const togglePkHdcp = (zone) => {
                if(zone==='f9') state.pk.hdcp_f9 = state.pk.hdcp_f9 >=9 ? 0 : state.pk.hdcp_f9+1;
                else state.pk.hdcp_b9 = state.pk.hdcp_b9 >=9 ? 0 : state.pk.hdcp_b9+1;
            };

            const saveData = () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            };
            
            const loadData = () => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // 注意：如果是舊版資料可能沒有 columnNames 或 handicaps 結構不同，需做容錯
                    if (!parsed.columnNames) {
                        parsed.columnNames = Array(12).fill("").map((_, i) => i < 4 ? basePlayers[i] : "");
                    }
                    // 確保 handicaps 是物件結構 (舊版是陣列)
                    if (Array.isArray(parsed.handicaps)) {
                        parsed.handicaps = { z1: Array(12).fill(4), z2: Array(12).fill(4) };
                    }
                    // 確保 scores 有 12 欄
                    ['z1', 'z2'].forEach(k => {
                        parsed.scores[k] = parsed.scores[k].map(row => {
                            if (row.length < 12) return [...row, ...Array(12 - row.length).fill("")];
                            return row;
                        });
                    });

                    Object.assign(state, parsed);
                }
            };

            const resetAllData = () => {
                if(confirm("確定清除所有紀錄?")) {
                    state.scores.z1 = Array(9).fill().map(() => Array(12).fill(""));
                    state.scores.z2 = Array(9).fill().map(() => Array(12).fill(""));
                    state.baSelections.z1 = Array(9).fill(null);
                    state.baSelections.z2 = Array(9).fill(null);
                    state.columnNames = Array(12).fill("").map((_, i) => i < 4 ? basePlayers[i] : "");
                    state.handicaps = { z1: Array(12).fill(4), z2: Array(12).fill(4) };
                    saveData();
                }
            };

            watch(state, () => {
                saveData();
            }, { deep: true });

            onMounted(() => {
                loadData();
            });

            return {
                ...toRefs(state),
                allPlayerNames,
                courseDB,
                toggleCourse,
                tryToggleZone,
                confirmZoneChange,
                handleHoleClick,
                updateScore,
                toggleBA,
                calculateGross,
                calculateGrandTotal,
                countBA,
                countBB,
                getZoneName,
                getZoneData,
                isRowEditing,
                getParBgClass,
                getScoreClass,
                calculateBB,
                getBBClass,
                cyclePlayerName,
                toggleHandicap,
                togglePkPlayer,
                togglePkHdcp,
                pkResults,
                resetAllData
            };
        }
    }).mount('#app');
</script>
</body>
</html>
